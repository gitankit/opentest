<?php

  /* Check to see if id and password is not empty and no spaces */
  if(ereg("^ +", $_POST['id']) || ereg("^ +", $_POST['password']) || strlen($_POST['id'])==0 || strlen($_POST['password'])==0)
  {
    header("Location: ./login.php");
    exit;
  }
  session_start();
  $host=$_SESSION['host'];
  $username=$_SESSION['username'];
  $password=$_SESSION['password'];
  $db=$_SESSION['db'];
  $connection=mysql_connect($host,$username,$password)
    or die('Cannot Connect to MySql. '.mysql_error());
  
  mysql_select_db($db)
    or die('Unable to select database. '.mysql_error());
  
  /* Unset db settings from session */
  unset($_SESSION['username']);
  unset($_SESSION['password']);
  unset($_SESSION['host']);
  unset($_SESSION['db']);
  
  
  /* Validation block for Student Login */
  if(strcmp("STUDENT",$_POST['user'])==0)
  {
    if(validate_student($connection,$_POST['id'],$_POST['password'])==0)
    {
      header("Location: ./student/studentlogin.php");
      $_SESSION['user']==$_POST['user'];
      unset($_POST['password']);
      /* Get Validated Student Details */    
      $_SESSION['student']=get_student_info($connection,$_POST['id']);      
      /*              list($_SESSION['rollno'],$_SESSION['name']  , $_SESSION['course'] , $_SESSION['branch'] ,$_SESSION['sem'] ,
      $_SESSION['section'] )=get_student_info($connection,$_POST['id']);*/
      mysql_close($connection);
      exit;
    }
    else
    {
      header("Location: ./login.php");
      $_SESSION['login_msg']="Invalid Login ";
      mysql_close($connection);
      exit;
    }
  }
  
  
  /* Validation block for Faculty Login */ 
  if(strcmp("FACULTY",$_POST['user'])==0)
  {
    
    if(validate_faculty($connection,$_POST['id'],$_POST['password'])==0)
    {
      header("Location: ./faculty/facultylogin.php");
      $_SESSION['user']==$_POST['user'];
      /* Get Validated Faculty Details */
      $_SESSION['faculty']=get_faculty_info($connection,$_POST['id']);
      exit;
    }
    else
    {
      header("Location: ./login.php");
      $_SESSION['login_msg']="Invalid Login ";
      exit;
    }
    
  }
  
  
  
  /* Validation Block for Administrator Login */ 
  if(strcmp("ADMINISTRATOR",$_POST['user'])==0)
  {
    /* For System Asministrator */  
    if(strcasecmp("admin",$_POST['id'])==0 || strcmp("system",$_POST['id'])==0)
    {
      if(validate_password_system($connection,$_POST['password'])==0)
      {
        header("Location: ./admin/adminlogin.php");
        /* Set details for Administrator */
        $_SESSION['id']=$_POST['id'];
        $_SESSION['name']="System";
        $_SESSION['department']="Administrative";
        $_SESSION['user']==$_POST['user'];
        $_SESSION['admin_id']=1;
        exit;
      }
      else
      {
        header("Location: ./login.php");
        $_SESSION['login_msg']="Invalid Login ";
        exit;
      }
    }
    
    /*For other Administrators */
    if(validate_admin($connection,$_POST['id'],$_POST['password'])==0)
    {
      header("Location: ./admin/adminlogin.php");
      $_SESSION['admin_id']=0;
      $_SESSION['user']==$_POST['user'];
      /* Get Validated Administrator Details */
      list($_SESSION['id'],$_SESSION['name'],$_SESSION['department'])=get_faculty_info($connection,$_POST['id']);
      exit;
    } 
    else
    {
      header("Location: ./login.php");
      $_SESSION['login_msg']="Invalid Login ";
      exit;
    }
  }
  
  
  
  /* 
  * Validates Faculty
  * 
  *@package Quiz
  *@author Ankit Sharma findme.ankit@gmail.com
  *@param MySql Connection , Faculty id , Faculty Password 
  *@return 0 on success , 1 on failure
  */
  function validate_faculty($connection,$username,$password)
  {
    $ret_val=1;
    $sql="SELECT id , password from Faculty where id='".$username."'" ;
    $query=mysql_query($sql,$connection);
    $row=mysql_fetch_array($query,MYSQL_ASSOC);
    $id=(int)$row[0];
    if(strcasecmp($row['id'],$username)==0 && strcmp($row['password'],$password)==0)
    {
      $ret_val=0;
    }
    
    return $ret_val;
  }
  
  
  /* 
  * Validates Student
  * 
  *@package Quiz
  *@author Ankit Sharma findme.ankit@gmail.com
  *@param MySql Connection , Student id , Student Password 
  *@return 0 on success , 1 on failure
  */
  function validate_student($connection,$username,$password)
  {
    $ret_val=1;
    $sql="SELECT Roll_no , password from Student where Roll_no=".$username;
    $query=mysql_query($sql,$connection);
    $row=mysql_fetch_array($query,MYSQL_ASSOC);
    if($username==$row['Roll_no'] && strcmp($row['password'],$password)==0)
    {
      $ret_val=0;
    }
    return $ret_val;
  }
  
  
  
  /* 
  * Validates Administrator
  * 
  *@package Quiz
  *@author Ankit Sharma findme.ankit@gmail.com
  *@param MySql Connection , Admin id , Admin Password 
  *@return 0 on success , 1 on failure
  */
  function validate_admin($connection,$username,$password)
  {
    $ret_val=1;
    $sql="SELECT * FROM Faculty INNER JOIN Administrators ON 
      Faculty.id=Administrators.Faculty_id WHERE id=".$username;
    $query=mysql_query($sql,$connection);
    $row=mysql_fetch_array($query,MYSQL_ASSOC);
    if(strcasecmp($row['id'],$username)==0 && strcmp($row['password'],$password)==0)
    {
      /*$sql_admin="SELECT Faculty_id from Administrators WHERE Faculty_id=".$row['id'];
      $query_admin=mysql_query($sql_admin,$connection);
      $row_admin=mysql_fetch_array($query_admin,MYSQL_ASSOC);
      if(strcasecmp($row[''],$row['id'])==0)
      {*/
      $ret_val=0;
      //}
    }
    return $ret_val;
  }
  
  
  
  /* 
  * Validates System Administrator
  * 
  *@package Quiz
  *@author Ankit Sharma findme.ankit@gmail.com
  *@param MySql Connection , Admin Password 
  *@return 0 on success , 1 on failure
  */
  function validate_password_system($connection,$password)
  {
    $ret_val=1;
    $sql="SELECT password FROM Administrator";
    $query=mysql_query($sql,$connection);
    $row=mysql_fetch_array($query,MYSQL_ASSOC);
    if(strcmp($row['password'],$password)==0)
    {
      $ret_val=0;
    }
    return $ret_val;
  }
  
  /* 
  * Retrieves Student Profile Information
  * 
  *@package Quiz
  *@author Ankit Sharma findme.ankit@gmail.com
  *@param MySql Connection , Student id  
  *@return Array (Roll No , Name , Course , Branch , Semester , Section )
  */
  function get_student_info($connection,$username)
  {
    $sql="SELECT * from Student_Info where Roll_no=".$username;
    $query=mysql_query($sql,$connection);
    $row=mysql_fetch_array($query,MYSQL_ASSOC);
    return array($row['Roll_no'],$row['Firstname'],$row['Lastname'],$row['sex'],$row['Course'],$row['Branch'],$row['Semester'],$row['Section'],$row['email']);
  }
  
  /* 
  * Retrieves Faculty Profile Information (Also used in Admin)
  * 
  *@package Quiz
  *@author Ankit Sharma findme.ankit@gmail.com
  *@param MySql Connection , Faculty id  
  *@return Array (ID , Name , Department )
  */
  function get_faculty_info($connection,$username)
  {
    $sql="SELECT * FROM Faculty_Info where id=".$username;
    $query=mysql_query($sql,$connection);
    $row=mysql_fetch_array($query,MYSQL_ASSOC);
    return array($row['id'],$row['Firstname'],$row['Lastname'],$row['Sex'],$row['Department'],$row['Designation'],$row['Email']);
  }
  
  ?>
